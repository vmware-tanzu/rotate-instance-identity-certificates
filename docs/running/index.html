<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Running the Tool - Rotate Instance Identity Certificates Docs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://vmware-tanzu.github.io/rotate-instance-identity-certificates/favicon.png">

  
  
  <link rel="stylesheet" href="/rotate-instance-identity-certificates/css/style.min.f3a9adc7827f84d41f3ca1fcade00d65cc7b7e59490558fa13825bc15f69eadf.css">
  
  <link rel="stylesheet" href="/rotate-instance-identity-certificates/css/copybutton.min.476cf5dd65a9af9c023c92279ab68dc31211540d4623c8e36c1b7e2d06ed31e4.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/rotate-instance-identity-certificates/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-docs">
      <a href="/rotate-instance-identity-certificates/docs/">
        <span>Docs</span>
      </a>
    </li>
    
    <li class="menu-item-releases">
      <a href="https://github.com/vmware-tanzu/rotate-instance-identity-certificates/releases">
        <span>Releases</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://vmware-tanzu.github.io/rotate-instance-identity-certificates"><img alt="Logo" src="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/images/GUID-8546DDD9-718A-42F7-9EDB-0BCC3A316BB6-low.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://vmware-tanzu.github.io/rotate-instance-identity-certificates"><img alt="Logo" src="/rotate-instance-identity-certificates" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/rotate-instance-identity-certificates/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-docs">
      <a href="/rotate-instance-identity-certificates/docs/">
        <span>Docs</span>
      </a>
    </li>
    
    <li class="menu-item-releases">
      <a href="https://github.com/vmware-tanzu/rotate-instance-identity-certificates/releases">
        <span>Releases</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <h4>Docs</h4>
  <ul>
    
    <li class="">
      <a href="https://vmware-tanzu.github.io/rotate-instance-identity-certificates/docs/overview/">Overview</a>
    </li>
    
    <li class="active ">
      <a href="https://vmware-tanzu.github.io/rotate-instance-identity-certificates/docs/running/">Running the Tool</a>
    </li>
    
    <li class="">
      <a href="https://vmware-tanzu.github.io/rotate-instance-identity-certificates/docs/faq/">Frequenty Asked Questions</a>
    </li>
    
  </ul>
</div>

          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Running the Tool</h1>
<div class="content ">
  <p>This tool will automatically rotate/update the older Diego root certificate
authority and Intermediate Identity Cert used by Diego for application instance
identity. This tool is not needed if you have already upgraded to Tanzu
Application Service 2.7 or later, as that version automatically rotates those
certs on upgrade.</p>
<p>The tool operates on all BOSH deployments that have Diego cells, including TAS,
TASW, and Isolation Segments for TAS.</p>
<p><em>NOTE</em> - we only support the full TAS deployment - small footprint runtime is
not currently supported.</p>
<p>The rotation process is a 2 step process:</p>
<ol>
<li>Add a new secondary root CA and intermediate identity certs. Deploy these new
certs directly using a BOSH deploy against all deployments with Diego cells.</li>
<li>Swap the new certs into place of the original certs in Credhub and then do a
selective Apply Changes through Operations Manager for each product with
Diego cells.</li>
</ol>
<p>At the end of each stage the tool will select a Diego cell and a router from
each deployment and validate the certs match what is in Credhub.</p>
<h1 id="execute-the-rotation">Execute the rotation</h1>
<h2 id="prerequisites">Prerequisites</h2>
<p>Download the latest binary from the <a href="/releases">releases</a> page. This is a linux
binary that will only run on the Operations Manager VM. Copy the binary to your
Operations Manager VM:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ scp ~/Downloads/riic -i ops-manager-private-key.pem ubuntu@ops-manager-fqdn:~/riic
</code></pre></div><p>It&rsquo;s recommended that the tool is run using <code>nohup</code>. This is important because
if you run a rotate command directly from your SSH session and your connection
terminates, so does the rotation process, potentially leaving your foundation in
an indeterminite state. To start the tool in this way run the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ nohup riic &lt;subcommand&gt; &amp;
</code></pre></div><p>This keeps the the command running even if your SSH session terminates. The
standard error and standard out are viewable in the nohup.out log file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ tail -f nohup.out
</code></pre></div><h2 id="passing-credentials">Passing credentials</h2>
<p>There are no flags to pass in secret values so that they will not appear in your
shell history. You will be prompted to enter the Operations Manager admin
user&rsquo;s/client&rsquo;s password. If you prefer this to be non-interactive, set the
<code>RIIC_PASSWORD</code> environment variable.</p>
<h2 id="saml-auth">SAML Auth</h2>
<p>If your Operations Manager does not use username/password authentication, simply
set the <code>--use-client-secret</code> (<code>-c</code>) flag, and put your client ID in the
<code>--username</code> argument and your client secret as the password (see above for
an explanation of password handling).</p>
<h2 id="diego-identity-cert-expiration-check">Diego Identity Cert Expiration Check</h2>
<p>Before attempting to rotate your instance identity certificates, it&rsquo;s a good
idea to check their expiration dates. This can easily be done using the
<code>riic check-expiry</code> command.</p>
<p>From your Operations Manager VM, run the following command, passing in your
Operations Manager credentials.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./riic --username admin check-expiry
</code></pre></div><p>This will display the Diego CA and Intermediate Identity Cert expiration dates
along with a warning if they&rsquo;re close to expiring.</p>
<h2 id="diego-identity-cert-rotation">Diego Identity Cert Rotation</h2>
<p>Once you&rsquo;ve checked the expiration dates and are ready to rotate certificates,
we recommend that you first ensure that all VMs in your TAS, isolation segment,
and TASW deployments are healthy. You can do this by looking at the <em>status</em>
tab for each tile in Operations Manager, or from the bosh CLI:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ bosh -d DEPLOYMENT_NAME vms
</code></pre></div><p>If there are VMs that are unhealthy, resolve those issues <em>before</em> proceeding with
the rotation. This may require you to recreate failing VMs.</p>
<p>When you&rsquo;ve confirmed that the deployment is healthy, proceed to rotate the
certificates.</p>
<p><em>NOTE</em> - When rotating certificates, the tool must run as the <code>tempest-web</code> user
to ensure there are no permission errors during the deployment. Make sure to
switch to the correct user before proceeding with the rotation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo su - tempest-web
</code></pre></div><p>If you forget this step, the operation will fail and ask you to switch users
before trying again.</p>
<p>Once you&rsquo;re running as <code>tempest-web</code>, run the following command to begin the
rotation:</p>
<p><em>NOTE:</em> We recommend you run the rotate command using <code>nohup</code> as noted above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ nohup ./riic --username admin rotate &amp;
$ tail -f nohup.out
</code></pre></div><p>This will rotate the Diego CA and Intermediate Identity certs and update all
BOSH jobs that reference these certs.</p>
<h2 id="diego-identity-cert-validation">Diego Identity Cert Validation</h2>
<p>As an additional check you can run the validate command when the rotation
completes. This will check all the certs on the diego cells and routers. Unlike
the validation done at the end of rotate, this will be done on <em>every</em> single
VM, not just the first. We don&rsquo;t recommend running this on very large
deployments.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./riic --username admin validate
</code></pre></div>
</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://www.zerostatic.io">www.zerostatic.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  
  

  
  

  
  
  <script type="text/javascript" src="/rotate-instance-identity-certificates/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  <script type="text/javascript" src="/rotate-instance-identity-certificates/js/copybutton.min.77c4760065e0857938ecfdd85f440240e070906eed2337a1089b8fd6de73f9f8.js"></script>
  

  
  
  
    
  


</body>

</html>
